<div class="container py-4">

  <!-- Top Bar -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div class="d-flex align-items-center gap-3">
      <h3 class="mb-0">ðŸ”¥ Fire Alerts Dashboard</h3>
      <div class="d-flex align-items-center gap-2">
        <span class="badge bg-danger">Emergency</span>
        <span class="badge bg-secondary">Rails</span>
        <span class="badge bg-secondary">Turbo</span>
        <span class="badge bg-secondary">HMAC</span>
      </div>
    </div>
    <div class="d-flex align-items-center gap-2">
      <button id="refresh-btn" class="btn btn-sm btn-outline-primary">Refresh</button>
    </div>
  </div>

  <!-- Subscribe to broadcasts -->
  <%= turbo_stream_from :alerts %>

  <!-- KPI Row -->
  <div class="row g-3 mb-3">
    <!-- ðŸ§¯ Total Alerts -->
    <div class="col-12 col-md-3">
      <div class="card border-0 shadow-sm h-100 kpi-card kpi-danger">
        <div class="card-body text-center">
          <div class="text-uppercase small fw-bold text-white">Total Alerts</div>
          <div class="fs-3 fw-bold text-danger"><%= @alert_receipts.size %></div>
        </div>
      </div>
    </div>

    <!-- â° Alerts in Last 24 Hours -->
    <div class="col-12 col-md-3">
      <div class="card border-0 shadow-sm h-100 kpi-card">
        <div class="card-body text-center">
          <div class="text-uppercase small fw-bold text-white">Alerts (Last 24h)</div>
          <div class="fs-3 fw-bold"><%= @alert_receipts.count { |r| r.created_at >= 24.hours.ago } %></div>
        </div>
      </div>
    </div>

    <!-- ðŸ“¡ Unique Senders -->
    <div class="col-12 col-md-3">
      <div class="card border-0 shadow-sm h-100 kpi-card">
        <div class="card-body text-center">
          <div class="text-uppercase small fw-bold text-white">Unique Senders</div>
          <div class="fs-3 fw-bold"><%= @alert_receipts.map(&:sender_tag).compact.uniq.size %></div>
        </div>
      </div>
    </div>

    <!-- ðŸ•’ Most Recent Alert -->
    <div class="col-12 col-md-3">
      <div class="card border-0 shadow-sm h-100 kpi-card">
        <div class="card-body text-center">
          <div class="text-uppercase small fw-bold text-white">Most Recent Alert</div>
          <div class="fs-6 fw-semibold text-nowrap manila-time"
               data-timestamp="<%= (@alert_receipts.first&.created_at || Time.current).iso8601 %>">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="card border-0 shadow-sm mb-3">
    <div class="card-body">
      <form class="row g-2 align-items-end" id="filters-form" onsubmit="return false;">
        <div class="col-12 col-md-6">
          <label class="form-label small text-muted">Search (sender/message)</label>
          <input type="search" class="form-control" id="q" placeholder="e.g. camera-1, fire, smoke">
        </div>
        <div class="col-6 col-md-3">
          <label class="form-label small text-muted">Since (hrs)</label>
          <select class="form-select" id="since">
            <option value="">Any</option>
            <option value="1">1h</option>
            <option value="6">6h</option>
            <option value="24">24h</option>
            <option value="48">48h</option>
          </select>
        </div>
      </form>
    </div>
  </div>

  <% if @alert_receipts.any? %>
    <div class="table-responsive">
      <table class="table table-hover align-middle" id="alerts-table">
        <thead class="table-dark">
          <tr>
            <th scope="col">Alert ID</th>
            <th scope="col">Sender</th>
            <th scope="col">Message</th>
            <th scope="col">Alert At (Manila)</th>
            <th scope="col">Received (Manila)</th>
            <th scope="col"></th>
          </tr>
        </thead>
        <tbody id="alerts_table_body">
          <%= render partial: "alert_receipts/row", collection: @alert_receipts, as: :r %>
        </tbody>
      </table>
    </div>
  <% else %>
    <div class="alert alert-info">
      No alerts yet. Send a POST to <code>/alert_hooks/fire</code> to see items appear here.
    </div>
  <% end %>
</div>

<!-- Minimal emergency accent styling -->
<style>
  .kpi-card { border-left: 6px solid #dee2e6; }
  .kpi-danger { border-left-color: #dc3545; }
  .text-truncate { max-width: 420px; }
</style>

<!-- JS: Manila time, filters, refresh -->
<script nonce="<%= content_security_policy_nonce %>">
(function() {
  const EM = (window.EMTECH = window.EMTECH || {});
  const TZ = "Asia/Manila";
  const fmt = new Intl.DateTimeFormat("en-PH", {
    timeZone: TZ, year: "numeric", month: "2-digit", day: "2-digit",
    hour: "2-digit", minute: "2-digit", second: "2-digit", hour12: false
  });

  function renderManilaTimes(root = document) {
    root.querySelectorAll(".manila-time").forEach(el => {
      const iso = el.getAttribute("data-timestamp");
      if (!iso) return;
      const d = new Date(iso);
      if (isNaN(d.getTime())) { el.textContent = "â€”"; return; }
      el.textContent = fmt.format(d);
      el.title = d.toISOString();
    });
  }

  function applyFilters() {
    const q = (document.getElementById("q")?.value || "").trim().toLowerCase();
    const since = document.getElementById("since")?.value || "";
    const cutoff = since ? (Date.now()/1000 - Number(since)*3600) : null;

    document.querySelectorAll("#alerts-table tbody tr.alert-row").forEach(tr => {
      const rowSender = tr.getAttribute("data-sender");
      const rowMsg = tr.getAttribute("data-message");
      const createdAt = Number(tr.getAttribute("data-created") || "0");
      let show = true;
      if (cutoff && createdAt < cutoff) show = false;
      if (q && !(rowSender.includes(q) || rowMsg.includes(q))) show = false;
      tr.style.display = show ? "" : "none";
    });
  }

  function setupFilters() {
    ["q","since"].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener("input", applyFilters);
    });
  }

  function setupRefresh() {
    const btn = document.getElementById("refresh-btn");
    if (btn) btn.addEventListener("click", () => window.location.reload());
  }

  document.addEventListener("turbo:before-stream-render", (ev) => {
    const fragment = ev.detail?.newStream?.templateElement?.content || null;
    if (fragment) renderManilaTimes(fragment);
  });

  EM.init = function() {
    renderManilaTimes();
    setupFilters();
    setupRefresh();
  };

  document.addEventListener("DOMContentLoaded", EM.init);
  document.addEventListener("turbo:load", EM.init);
})();
</script>
