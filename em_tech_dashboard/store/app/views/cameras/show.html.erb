<div class="container-fluid py-3">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div class="d-flex align-items-center gap-3">
      <h3 class="mb-0">Fire Monitor</h3>
      <div class="d-flex align-items-center gap-2">
        <span class="badge bg-secondary">Rails</span>
        <span class="badge bg-secondary">YOLO</span>
        <span class="badge bg-secondary">MQTT</span>
        <span id="mqtt-status" class="badge bg-dark text-dark">Waiting…</span>
      </div>
    </div>
    <div class="d-flex align-items-center gap-2">
      <button id="refresh-btn" class="btn btn-sm btn-outline-primary">Refresh</button>
    </div>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-6 col-lg-3">
      <div class="card shadow-sm h-100 text-bg-dark">
        <div class="card-body">
          <div class="text-muted small">Latest Message</div>
          <div id="last-recv" class="fs-5">no messages yet</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-lg-3">
      <div class="card shadow-sm h-100 text-bg-dark">
        <div class="card-body">
          <div class="text-muted small">Feed Count (visible)</div>
          <div id="feed-count" class="fs-5">0</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-lg-3">
      <div class="card shadow-sm h-100 text-bg-dark">
        <div class="card-body">
          <div class="text-muted small">Stream Health</div>
          <div id="stream-health" class="fs-5">checking…</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-lg-3">
      <div class="card shadow-sm h-100 text-bg-dark">
        <div class="card-body">
          <div class="text-muted small">MQTT Topic</div>
          <div class="fs-6"><code>site/lab1/ingest/rails</code></div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-12 col-lg-5">
      <div class="card shadow-sm mb-3 text-bg-dark">
        <div class="card-header d-flex align-items-center justify-content-between">
          <strong>Live Feed</strong>
          <small class="text-muted">stream.py must be running & token must match</small>
        </div>
        <div class="card-body">
          <div class="rounded overflow-hidden bg-black mx-auto"
               style="aspect-ratio:3/4; width:min(420px, 90vw); max-height:80vh;">
            <img id="mjpeg" src="<%= @stream_url %>"
                 alt="YOLO Live Feed"
                 style="width:100%; height:100%; object-fit:contain; display:block;">
          </div>
        </div>
      </div>

      <div class="card shadow-sm text-bg-dark">
        <div class="card-header">
          <strong>Camera Controls</strong>
        </div>
        <div class="card-body">
          <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-outline-light btn-sm" onclick="forceReloadStream()">Reload Stream</button>
            <button class="btn btn-outline-light btn-sm" onclick="toggleAutoRefresh()">Toggle Auto-Refresh</button>
          </div>
          <div class="text-muted small mt-2">Tip: if the MJPEG hangs, reload. If it keeps failing, your token or host is wrong.</div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-7">
      <div class="card shadow-sm mb-3 text-bg-dark">
        <div class="card-header d-flex align-items-center justify-content-between">
          <strong>MQTT Live (latest)</strong>
          <small class="text-muted">Polling <code>/messages.json</code> every 5s</small>
        </div>
        <div class="card-body p-0">
          <div class="list-group list-group-flush" id="mqtt-feed" style="max-height: 52vh; overflow:auto;">
            </div>
        </div>
        <div class="card-footer d-flex align-items-center justify-content-between">
          <small class="text-muted">Topic: <code>site/lab1/ingest/rails</code></small>
          <small class="text-muted">Newest status: <span id="badge-shadow" class="badge bg-light text-dark">—</span></small>
        </div>
      </div>

      <div class="card shadow-sm text-bg-dark">
        <div class="card-header d-flex align-items-center justify-content-between">
          <strong>Recent Alerts</strong>
          <small class="text-muted">DB-backed: latest ≤10 from <code>/alerts.json</code></small>
        </div>
        <div class="card-body p-0">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-dark">
              <tr>
                <th style="width:28%;">When</th>
                <th style="width:28%;">Sender</th>
                <th>Message</th>
              </tr>
            </thead>
            <tbody id="alerts-tbody">
              </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
(function() {
  // ===== Force Manila timezone for all displayed timestamps =====
  const MANILA_TZ = 'Asia/Manila';
  const dtfManila = new Intl.DateTimeFormat(undefined, {
    timeZone: MANILA_TZ,
    year: 'numeric', month: '2-digit', day: '2-digit',
    hour: '2-digit', minute: '2-digit', second: '2-digit'
  });
  const fmtManila = (d) => d ? dtfManila.format(d) : '';

  // ===== MJPEG auto-reconnect + periodic refresh =====
  const img  = document.getElementById('mjpeg');
  const base = "<%= @stream_url %>";
  const url  = () => base + (base.includes('?') ? '&' : '?') + "_t=" + Date.now();
  let autoRefreshTimer = null;

  function reloadSoon(ms=1500){ setTimeout(()=> img.src = url(), ms); }
  function startAutoRefresh(){
    if (autoRefreshTimer) return;
    autoRefreshTimer = setInterval(() => img.src = url(), 5 * 60 * 1000);
  }
  function stopAutoRefresh(){
    if (!autoRefreshTimer) return;
    clearInterval(autoRefreshTimer);
    autoRefreshTimer = null;
  }
  window.forceReloadStream = () => { img.src = url(); };
  window.toggleAutoRefresh = () => { autoRefreshTimer ? stopAutoRefresh() : startAutoRefresh(); };

  img.addEventListener('error', () => reloadSoon());
  startAutoRefresh();

  const streamHealthEl = document.getElementById('stream-health');
  let lastStreamOkAt = null;
  img.addEventListener('load', () => { lastStreamOkAt = Date.now(); updateStreamHealth(); });
  function updateStreamHealth(){
    if (!streamHealthEl) return;
    if (!lastStreamOkAt) { streamHealthEl.textContent = 'checking…'; return; }
    const sec = Math.floor((Date.now() - lastStreamOkAt)/1000);
    streamHealthEl.textContent = sec < 10 ? 'OK' : (sec < 60 ? `quiet ${sec}s` : `quiet ${Math.floor(sec/60)}m`);
  }
  setInterval(updateStreamHealth, 2000);

  // ===== MQTT live panel (poll /messages.json) =====
  const FEED_LIMIT   = 20;
  const POLL_MS      = 5000; // can drop to 300–500ms later if you want faster UI
  const feedEl       = document.getElementById('mqtt-feed');
  const statusBadge  = document.getElementById('mqtt-status');
  const lastRecvEl   = document.getElementById('last-recv');
  const countEl      = document.getElementById('feed-count');
  const refreshBtn   = document.getElementById('refresh-btn');
  const alertsBody   = document.getElementById('alerts-tbody');
  const badgeShadow  = document.getElementById('badge-shadow');

  // Client-side cache & delta anchor (messages only)
  let allRows = [];          // newest -> oldest
  let newestId = null;       // last anchor for delta fetches

  function timeAgo(ts) {
    if (!ts) return '';
    const diff = (Date.now() - new Date(ts).getTime()) / 1000;
    if (diff < 60)  return `${Math.floor(diff)}s ago`;
    if (diff < 3600) return `${Math.floor(diff/60)}m ago`;
    return `${Math.floor(diff/3600)}h ago`;
  }

  function setStatus(ageSec) {
    // This badge is on the main black background, so its colors are fine.
    if (isNaN(ageSec)) {
      statusBadge.className = "badge bg-warning text-dark";
      statusBadge.textContent = "Waiting…";
      badgeShadow.textContent = "—";
      return;
    }
    if (ageSec <= 5) {
      statusBadge.className = "badge bg-success";
      statusBadge.textContent = "Live";
      badgeShadow.textContent = "fresh";
    } else if (ageSec <= 30) {
      statusBadge.className = "badge bg-info";
      statusBadge.textContent = "Idle";
      badgeShadow.textContent = "recent";
    } else {
      statusBadge.className = "badge bg-secondary";
      statusBadge.textContent = "Stale";
      badgeShadow.textContent = "stale";
    }
  }

  function renderRows(rows){
    feedEl.innerHTML = rows.map(m => {
      // *** MODIFIED ***
      // These badges are inside the RED card, so they need to be light.
      const tz = m.zone ? `<span class="badge bg-light text-danger me-1">${m.zone}</span>` : "";
      const lvl = m.level ? `<span class="badge bg-light text-dark me-1">${m.level}</span>` : "";
      const nt = m.nonce ? `<code class="text-muted">${m.nonce}</code>` : "";
      const sender = m.sender_tag || 'unknown';
      const msg = (m.message || '').toString();
      const created = m.created_at ? new Date(m.created_at) : null;

      // The list-group-item will be dark thanks to `data-bs-theme="dark"`
      return `
        <div class="list-group-item">
          <div class="d-flex justify-content-between align-items-start">
            <div class="me-2">
              <div class="fw-semibold">${sender}</div>
              <div class="small text-muted">${created ? fmtManila(created) : ''} • ${timeAgo(m.created_at)}</div>
            </div>
            <div>${nt}</div>
          </div>
          <div class="mt-2">${lvl}${tz}<span>${msg}</span></div>
        </div>
      `;
    }).join('');
  }

  // ===== Recent Alerts (DB-backed) =====
  const ALERTS_POLL_MS = 500;  // poll server for latest alerts
  const MAX_ALERT_ROWS = 10;   // render cap (server already limits to 10)

  function renderAlertsFromData(alerts){
    // Alerts come newest-first. Each has: id, start_second, end_second, created_at, representative{...}
    alertsBody.innerHTML = (alerts || []).slice(0, MAX_ALERT_ROWS).map(a => {
      const rep = a.representative || {};
      const whenDate = rep.created_at ? new Date(rep.created_at)
                       : (a.start_second ? new Date(a.start_second * 1000) : null);
      const whenText = whenDate ? `${fmtManila(whenDate)} • ${timeAgo(whenDate.toISOString())}` : '';
      const sender = rep.sender_tag || '—';
      const msg = (rep.message || '').toString();

      // *** MODIFIED ***
      // This badge is inside the BLUE card, so make it light.
      return `
        <tr>
          <td>${whenText}</td>
          <td><span class="badge bg-light text-dark">${sender}</span></td>
          <td class="text-truncate" style="max-width: 380px;">${msg}</td>
        </tr>
      `;
    }).join('');
  }

  async function loadAlerts(){
    try {
      const res = await fetch(`/alerts.json`, { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      renderAlertsFromData(data);
    } catch (e) {
      console.warn('Alerts load failed:', e);
      // keep last rendered alerts; no UI state flip needed
    }
  }

  // ===== Loader: fetch + render messages =====
  async function loadFeed() {
    try {
      const params = new URLSearchParams();
      params.set('limit', FEED_LIMIT);
      if (newestId) params.set('since_id', newestId);

      const res = await fetch(`/messages.json?${params.toString()}`, { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      if (!newestId) {
        allRows = data;
      } else if (data.length > 0) {
        allRows = [...data, ...allRows];
      }

      // De-dupe by id, keep newest first, trim feed list
      const seenIds = new Set();
      allRows = allRows.filter(r => {
        if (seenIds.has(r.id)) return false;
        seenIds.add(r.id);
        return true;
      }).sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
        .slice(0, FEED_LIMIT);

      if (allRows.length > 0) newestId = allRows[0].id;

      // Render live list
      renderRows(allRows);

      // badges / counters
      countEl.textContent = allRows.length.toString();
      if (allRows.length > 0) {
        const newest = new Date(allRows[0].created_at);
        const ageSec = (Date.now() - newest.getTime())/1000;
        setStatus(ageSec);
        lastRecvEl.textContent = `last ${timeAgo(newest.toISOString())}`;
      } else {
        setStatus(NaN);
        lastRecvEl.textContent = 'no messages yet';
      }
    } catch (e) {
      setStatus(9999);
      console.warn('Feed load failed:', e);
    }
  }

  // Manual refresh + initial load
  refreshBtn.addEventListener('click', () => { loadFeed(); loadAlerts(); });
  loadFeed();
  loadAlerts();

  // Auto-poll
  let feedTimer   = setInterval(loadFeed,   POLL_MS);
  let alertsTimer = setInterval(loadAlerts, ALERTS_POLL_MS);

  // Pause polling when tab is hidden; resume when visible
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      if (feedTimer)   { clearInterval(feedTimer);   feedTimer = null; }
      if (alertsTimer) { clearInterval(alertsTimer); alertsTimer = null; }
    } else {
      loadFeed();  loadAlerts();
      if (!feedTimer)   feedTimer   = setInterval(loadFeed,   POLL_MS);
      if (!alertsTimer) alertsTimer = setInterval(loadAlerts, ALERTS_POLL_MS);
    }
  });

  // Optional: clear timers on page unload
  window.addEventListener('beforeunload', () => {
    if (feedTimer)   clearInterval(feedTimer);
    if (alertsTimer) clearInterval(alertsTimer);
    if (autoRefreshTimer) clearInterval(autoRefreshTimer);
  });
})();
</script>